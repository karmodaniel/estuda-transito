<div class="quiz-page">
  <!-- Loading -->
  <div *ngIf="loading()" class="loading-container">
    <nz-spin nzSize="large">
      <span class="loading-text">Carregando quiz...</span>
    </nz-spin>
  </div>

  <!-- Tela inicial -->
  <div
    *ngIf="!loading() && !quizIniciado() && !quizFinalizado()"
    class="quiz-inicial"
  >
    <nz-card class="quiz-card">
      <div class="quiz-header">
        <div class="quiz-icon">üéØ</div>
        <h1>Estuda Tr√¢nsito</h1>
        <p>Teste seus conhecimentos sobre placas de tr√¢nsito brasileiras!</p>
      </div>

      <div class="quiz-info">
        <h3>Informa√ß√µes do Quiz</h3>
        <div class="info-item">
          <strong>Categoria:</strong>
          {{ configQuiz().categoriaSelecionada || "Todas as categorias" }}
        </div>
        <div class="info-item">
          <strong>N√∫mero de Op√ß√µes:</strong> {{ configQuiz().numOpcoes }} op√ß√µes
          por quest√£o
        </div>
        <div class="info-item">
          <strong>Modo:</strong>
          {{ configQuiz().modoAleatorio ? "Aleat√≥rio" : "Sequencial" }}
        </div>
      </div>

      <div class="quiz-actions">
        <button
          nz-button
          nzType="primary"
          nzSize="large"
          (click)="iniciarQuiz()"
        >
          <span nz-icon nzType="play-circle" nzTheme="outline"></span>
          Iniciar Quiz
        </button>
      </div>
    </nz-card>
  </div>

  <!-- Quiz em andamento -->
  <div
    *ngIf="quizIniciado() && !quizFinalizado() && getQuestaoAtual()"
    class="quiz-ativo"
  >
    <nz-card class="quiz-card">
      <!-- Progresso -->
      <div class="progress-section">
        <div class="progress-info">
          <span class="questao-atual">
            Quest√£o {{ questaoAtual() + 1 }} de {{ totalQuestoes() }}
          </span>
          <span class="pontuacao">Pontua√ß√£o: {{ pontuacao() }}</span>
        </div>
        <nz-progress
          [nzPercent]="getProgresso()"
          [nzShowInfo]="false"
          nzStrokeColor="#1890ff"
        ></nz-progress>
      </div>

      <!-- Quest√£o -->
      <div class="questao-section">
        <div class="questao-header">
          <h2>Qual √© o nome desta placa de tr√¢nsito?</h2>
        </div>

        <!-- Imagem da placa -->
        <div class="placa-imagem">
          <img
            [src]="getQuestaoAtual()!.placa.imagem_url"
            [alt]="getQuestaoAtual()!.placa.nome"
            (error)="onImageError($event)"
            class="placa-img"
          />
        </div>

        <!-- Op√ß√µes de resposta -->
        <div class="opcoes-resposta">
          <div
            *ngFor="let opcao of getQuestaoAtual()!.opcoes; let i = index"
            class="opcao-item"
            [class.selecionada]="
              getQuestaoAtual()!.respostaSelecionada === opcao
            "
            [class.correta]="
              getQuestaoAtual()!.respondida &&
              opcao === getQuestaoAtual()!.respostaCorreta
            "
            [class.incorreta]="
              getQuestaoAtual()!.respondida &&
              getQuestaoAtual()!.respostaSelecionada === opcao &&
              opcao !== getQuestaoAtual()!.respostaCorreta
            "
            (click)="selecionarResposta(getQuestaoAtual()!, opcao)"
          >
            <div class="opcao-radio">
              <input
                type="radio"
                [name]="'questao-' + questaoAtual()"
                [value]="opcao"
                [disabled]="getQuestaoAtual()!.respondida"
                [checked]="getQuestaoAtual()!.respostaSelecionada === opcao"
                (change)="selecionarResposta(getQuestaoAtual()!, opcao)"
              />
            </div>
            <div class="opcao-texto">
              {{ opcao }}
            </div>
            <div class="opcao-status" *ngIf="getQuestaoAtual()!.respondida">
              <span
                *ngIf="opcao === getQuestaoAtual()!.respostaCorreta"
                nz-icon
                nzType="check-circle"
                nzTheme="twotone"
                nzTwotoneColor="#52c41a"
                class="status-icon correto"
              ></span>
              <span
                *ngIf="
                  getQuestaoAtual()!.respostaSelecionada === opcao &&
                  opcao !== getQuestaoAtual()!.respostaCorreta
                "
                nz-icon
                nzType="close-circle"
                nzTheme="twotone"
                nzTwotoneColor="#ff4d4f"
                class="status-icon incorreto"
              ></span>
            </div>
          </div>
        </div>

        <!-- Feedback da resposta -->
        <div *ngIf="getQuestaoAtual()!.respondida" class="feedback-resposta">
          <div
            class="feedback-alert"
            [class.success]="getQuestaoAtual()!.acertou"
            [class.error]="!getQuestaoAtual()!.acertou"
          >
            <div class="feedback-message">
              {{
                getQuestaoAtual()!.acertou
                  ? "Parab√©ns! Resposta correta!"
                  : "Ops! Resposta incorreta."
              }}
            </div>
            <div class="feedback-description">
              Resposta correta: {{ getQuestaoAtual()!.respostaCorreta }}
            </div>
          </div>
        </div>

        <!-- Navega√ß√£o -->
        <div class="navegacao-questoes">
          <button
            nz-button
            nzType="default"
            (click)="questaoAnterior()"
            [disabled]="questaoAtual() === 0"
          >
            <span nz-icon nzType="left"></span>
            Anterior
          </button>

          <button
            nz-button
            nzType="primary"
            (click)="proximaQuestao()"
            [disabled]="!getQuestaoAtual()!.respondida"
          >
            <span *ngIf="questaoAtual() < totalQuestoes() - 1; else finalizar">
              Pr√≥xima
              <span nz-icon nzType="right"></span>
            </span>
            <ng-template #finalizar>
              Finalizar Quiz
              <span nz-icon nzType="check"></span>
            </ng-template>
          </button>
        </div>
      </div>
    </nz-card>
  </div>

  <!-- Resultado final -->
  <div *ngIf="!loading() && quizFinalizado()" class="quiz-resultado">
    <nz-card class="quiz-card">
      <div class="resultado-header">
        <div class="resultado-icon">
          <span
            *ngIf="pontuacao() >= totalQuestoes() * 0.7"
            nz-icon
            nzType="trophy"
            nzTheme="twotone"
            nzTwotoneColor="#faad14"
          ></span>
          <span
            *ngIf="pontuacao() < totalQuestoes() * 0.7"
            nz-icon
            nzType="star"
            nzTheme="twotone"
            nzTwotoneColor="#1890ff"
          ></span>
        </div>
        <h1>Quiz Finalizado!</h1>
        <p>Sua pontua√ß√£o final</p>
      </div>

      <div class="resultado-pontuacao">
        <div class="pontuacao-numerica">
          <span class="pontos">{{ pontuacao() }}</span>
          <span class="total">/ {{ totalQuestoes() }}</span>
        </div>
        <div class="pontuacao-percentual">
          {{ ((pontuacao() / totalQuestoes()) * 100).toFixed(0) }}%
        </div>
      </div>

      <div class="resultado-mensagem">
        <div
          class="resultado-alert"
          [class.success]="pontuacao() >= totalQuestoes() * 0.7"
          [class.warning]="pontuacao() < totalQuestoes() * 0.7"
        >
          {{
            pontuacao() >= totalQuestoes() * 0.7
              ? "Excelente! Voc√™ tem um bom conhecimento sobre placas de tr√¢nsito!"
              : "Continue estudando! Voc√™ pode melhorar!"
          }}
        </div>
      </div>

      <div class="resultado-acoes">
        <button
          nz-button
          nzType="primary"
          nzSize="large"
          (click)="reiniciarQuiz()"
        >
          <span nz-icon nzType="reload"></span>
          Jogar Novamente
        </button>
      </div>
    </nz-card>
  </div>
</div>
